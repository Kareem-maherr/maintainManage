import { useState, useEffect } from 'react';
import { db } from '../config/firebase';
import { collection, onSnapshot, query, where, getDocs } from 'firebase/firestore';
import { motion, AnimatePresence } from 'framer-motion';
import { useLanguage } from '../contexts/LanguageContext';

interface Engineer {
  id: string;
  email: string;
  displayName: string;
  role: string;
  createdAt: any;
  specialties?: string[];
  currentProject?: string;
  availability?: 'available' | 'busy' | 'away';
  assignedProjects?: { [key: string]: any }[];
}

const EngineersList = () => {
  const [engineers, setEngineers] = useState<Engineer[]>([]);
  const [loading, setLoading] = useState(true);
  const [expandedEngineerId, setExpandedEngineerId] = useState<string | null>(null);
  const [printing, setPrinting] = useState<string | null>(null);
  const { t, tEn } = useLanguage();

  const handlePrintEngineerDetails = async (engineer: Engineer, e: React.MouseEvent) => {
    e.stopPropagation();
    setPrinting(engineer.id);
    try {
      // First, get all tickets and log their structure
      const ticketsSnapshot = await getDocs(collection(db, 'tickets'));
      const allTickets = ticketsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log('All tickets count:', allTickets.length);

      // Log all ticket fields to understand their structure
      if (allTickets.length > 0) {
        console.log('First ticket full structure:', JSON.stringify(allTickets[0], null, 2));

        // Log all field names from all tickets to find the project reference field
        const allFields = new Set();
        allTickets.forEach(ticket => {
          Object.keys(ticket).forEach(key => allFields.add(key));
        });
        console.log('All field names found in tickets:', Array.from(allFields));

        // Check what fields might contain project references
        allTickets.forEach((ticket, index) => {
          console.log(`Ticket ${index} potential project references:`, {
            id: ticket.id,
            title: (ticket as any).title,
            projectId: (ticket as any).projectId,
            project_id: (ticket as any).project_id,
            project: (ticket as any).project,
            companyId: (ticket as any).companyId,
            company: (ticket as any).company,
            company_id: (ticket as any).company_id
          });
        });
      }

      const projectsWithTickets = await Promise.all(
        (engineer.assignedProjects || []).map(async (project) => {
          console.log('Processing project:', { id: project.id, companyName: project.companyName });

          // Try all possible matching strategies
          const tickets = allTickets.filter(ticket => {
            // For debugging, log all potential matching fields for this ticket
            const matchingFields = {
              projectId: (ticket as any).projectId,
              project_id: (ticket as any).project_id,
              project: (ticket as any).project,
              companyId: (ticket as any).companyId,
              company: (ticket as any).company,
              company_id: (ticket as any).company_id
            };

            // Try to match by any field
            const isMatch =
              matchingFields.projectId === project.id ||
              matchingFields.project_id === project.id ||
              matchingFields.project === project.id ||
              matchingFields.companyId === project.id ||
              matchingFields.company_id === project.id ||
              matchingFields.company === project.companyName;

            if (isMatch) {
              console.log('MATCH FOUND for ticket:', ticket.id, 'with project:', project.companyName);
            }

            return isMatch;
          });

          console.log(`Tickets for project ${project.id} (${project.companyName}):`, tickets.length);

          // For this project, manually assign tickets if none were found
          if (tickets.length === 0 && allTickets.length > 0) {
            console.log('No tickets matched automatically. Checking if we can match by company name in ticket title or description');

            // Try matching by company name in title or description as fallback
            const fallbackTickets = allTickets.filter(ticket => {
              const title = String((ticket as any).title || '').toLowerCase();
              const description = String((ticket as any).description || '').toLowerCase();
              const companyNameLower = project.companyName.toLowerCase();

              return title.includes(companyNameLower) || description.includes(companyNameLower);
            });

            if (fallbackTickets.length > 0) {
              console.log('Found tickets by company name in title/description:', fallbackTickets.length);
              // Use these tickets instead
              tickets.push(...fallbackTickets);
            }
          }

          const openTickets = tickets.filter(ticket => {
            const status = (ticket as any).status?.toLowerCase();
            return status !== 'resolved';
          });
          const resolvedTickets = tickets.filter(ticket => {
            const status = (ticket as any).status?.toLowerCase();
            return status === 'resolved';
          });

          console.log(`Open tickets for ${project.companyName}:`, openTickets.length);
          console.log(`Resolved tickets for ${project.companyName}:`, resolvedTickets.length);

          return {
            ...project,
            tickets: {
              open: openTickets,
              resolved: resolvedTickets
            }
          };
        })
      );

      console.log('Projects with tickets:', projectsWithTickets);
      const totalOpenTickets = projectsWithTickets.reduce((acc, project) => acc + project.tickets.open.length, 0);
      const totalResolvedTickets = projectsWithTickets.reduce((acc, project) => acc + project.tickets.resolved.length, 0);

      const content = `
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arab Emergency Company - Engineering Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            width: 21cm;
            min-height: 29.7cm;
            margin: 0 auto;
            padding: 0;
            background-color: white;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .page-container {
            min-height: 29.7cm;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        .header {
            padding: 1.5cm 1.5cm 0.5cm 1.5cm;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 1.5cm;
        }
        
        .logo {
            width: 120px;
            height: auto;
            margin-right: 20px;
        }
        
        .company-info {
            flex: 1;
        }
        
        .company-name {
            color: #2F3290;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .company-subtitle {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
        
        .report-title-container {
            text-align: center;
            margin-top: 1.5cm;
        }
        
        .report-title {
            font-size: 32px;
            font-weight: bold;
            color: #2F3290;
            margin-bottom: 10px;
        }
        
        .report-subtitle {
            font-size: 18px;
            color: #555;
            font-weight: 500;
        }
        
        /* Content Area Styles */
        .content {
            flex: 1;
            padding: 1.5cm;
            position: relative;
        }
        
        .content-placeholder {
            color: #777;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #2F3290;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .form-row {
            display: flex;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            margin-right: 20px;
        }
        
        .form-group:last-child {
            margin-right: 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #444;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .signature-area {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        
        .signature-line {
            width: 300px;
            border-bottom: 1px solid #333;
            margin: 40px auto 10px;
            padding-top: 30px;
        }
        
        .signature-label {
            text-align: center;
            font-style: italic;
            color: #555;
        }
        
        /* Footer Styles */
        .footer {
            background-color: #575ac9;
            color: white;
            padding: 1cm 1.5cm;
            text-align: center;
            margin-top: auto;
            width: 100%;
        }
        
        .engineer-name {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .footer-note {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        /* Print-specific styles */
        @media print {
            body {
                box-shadow: none;
                width: 100%;
            }
            
            .header, .content, .footer {
                padding: 1cm;
            }
            
            .no-print {
                display: none;
            }
        }
        
        /* Instructions for users */
        .instructions {
            background-color: #f5f5f5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #2F3290;
        }
        
        .instructions h4 {
            margin-bottom: 10px;
            color: #2F3290;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header Section -->
        <div class="header">
            <div class="logo-container">
                <!-- SVG Logo -->
                <svg class="logo" viewBox="0 0 104 191" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 0 C0.71395432 0.00009567 1.42790863 0.00019135 2.16349792 0.00028992 C4.47375581 0.00399774 6.78358112 0.02288786 9.09375 0.04296875 C10.67683777 0.04981586 12.25992704 0.05632518 13.84301758 0.0625 C25.44422173 0.12734742 37.01549954 0.47741181 48.59375 1.23046875 C48.59375 3.21046875 48.59375 5.19046875 48.59375 7.23046875 C47.61109161 7.23593719 47.61109161 7.23593719 46.60858154 7.24151611 C39.79517029 7.28329988 32.98243525 7.35261673 26.16943359 7.43798828 C23.62620809 7.46622831 21.08289433 7.48742765 18.53955078 7.50146484 C14.88528147 7.52285152 11.23207686 7.56948266 7.578125 7.62109375 C5.87012726 7.62293671 5.87012726 7.62293671 4.12762451 7.62481689 C3.06682678 7.64453552 2.00602905 7.66425415 0.91308594 7.68457031 C-0.01957092 7.69345276 -0.95222778 7.70233521 -1.91314697 7.71148682 C-5.27615145 8.41155358 -6.42154818 9.43893002 -8.40625 12.23046875 C-8.9986757 15.40031844 -8.9986757 15.40031844 -8.89208984 18.98681641 C-8.89588654 19.6571843 -8.89968323 20.32755219 -8.90359497 21.01823425 C-8.91098698 23.22748035 -8.88964382 25.43540271 -8.8671875 27.64453125 C-8.86480266 29.18101853 -8.86389784 30.71750876 -8.8644104 32.2539978 C-8.86128502 35.47029943 -8.84473734 38.68615444 -8.81787109 41.90234375 C-8.7838341 46.02968631 -8.77624424 50.15653963 -8.77776146 54.28400612 C-8.77721836 57.45468841 -8.76626191 60.62526327 -8.75175858 63.79590988 C-8.74538543 65.31818199 -8.74145047 66.84046628 -8.73997116 68.36275101 C-8.73564672 70.48634975 -8.71816694 72.60942373 -8.69677734 74.73291016 C-8.68915375 75.9421817 -8.68153015 77.15145325 -8.67367554 78.39736938 C-8.69731764 81.36441894 -8.69731764 81.36441894 -6.40625 83.23046875 C-4.20374008 83.69053221 -4.20374008 83.69053221 -1.78125 83.85546875 C-0.96398438 83.93023437 -0.14671875 84.005 0.6953125 84.08203125 C1.63503906 84.15550781 1.63503906 84.15550781 2.59375 84.23046875 C2.31640349 82.29523429 2.31640349 82.29523429 1.59375 80.23046875 C-0.36772874 78.84108798 -2.36791576 77.50442765 -4.40625 76.23046875 C-5.62892827 73.7851122 -5.53553861 72.20668825 -5.5390625 69.47265625 C-5.54123779 68.46928223 -5.54341309 67.4659082 -5.5456543 66.43212891 C-5.54090088 65.33433105 -5.53614746 64.2365332 -5.53125 63.10546875 C-5.52714111 61.97286621 -5.52303223 60.84026367 -5.51879883 59.67333984 C-5.49483901 55.85883407 -5.45499552 52.04472027 -5.40625 48.23046875 C-5.3933493 47.1784729 -5.3933493 47.1784729 -5.38018799 46.10522461 C-5.32361371 41.73489253 -5.24509989 37.36563561 -5.14178467 32.99615479 C-5.10985509 31.57319918 -5.08268639 30.15012848 -5.06036377 28.72698975 C-5.02713727 26.72005066 -4.97296413 24.71349182 -4.91796875 22.70703125 C-4.89178467 21.55283691 -4.86560059 20.39864258 -4.83862305 19.20947266 C-4.35368967 15.86833371 -3.71757414 14.64334566 -1.40625 12.23046875 C0.74453735 11.74272156 0.74453735 11.74272156 3.27587891 11.76049805 C4.23132095 11.75762787 5.186763 11.75475769 6.17115784 11.75180054 C7.21037888 11.76925323 8.24959991 11.78670593 9.3203125 11.8046875 C10.40444931 11.80747711 11.48858612 11.81026672 12.60557556 11.81314087 C16.1437562 11.8278512 19.68084934 11.87191063 23.21875 11.91796875 C25.6366287 11.93693115 28.05451662 11.95475088 30.47241211 11.97143555 C36.42808698 12.0192744 42.38299669 12.09452051 48.3381958 12.1829834 C51.31380822 12.22638553 54.28940939 12.26341781 57.26513672 12.29785156 C61.20214367 12.34574098 65.13830506 12.41109228 69.074646 12.49795532 C70.45383841 12.52777952 71.83312149 12.55368771 73.21246338 12.57553101 C75.09118209 12.60828356 76.96948303 12.66287441 78.84765625 12.71875 C79.87189697 12.74493408 80.8961377 12.77111816 81.95141602 12.7980957 C85.11997714 13.31657688 86.33630668 13.95009477 88.59375 16.23046875 C89.10168457 19.18382263 89.10168457 19.18382263 89.11132812 22.84155273 C89.1183374 23.50856201 89.12534668 24.17557129 89.13256836 24.86279297 C89.15017414 27.06780633 89.13851677 29.27153607 89.125 31.4765625 C89.12769453 33.00969184 89.13157663 34.54281951 89.13659668 36.07594299 C89.14249543 39.28980777 89.1339184 42.50322792 89.11523438 45.71704102 C89.09246314 49.83436521 89.10555288 53.95064544 89.12952423 58.06793118 C89.14398884 61.23443953 89.139373 64.40070102 89.12901306 67.56721687 C89.12634658 69.08505438 89.12961284 70.60291438 89.13893127 72.12072563 C89.14910647 74.24441602 89.13358517 76.36642491 89.11132812 78.48999023 C89.10814575 79.69783676 89.10496338 80.90568329 89.10168457 82.15013123 C88.49333884 85.83940594 87.53344547 86.99179199 84.59375 89.23046875 C81.17142028 90.37124532 78.50701783 90.32861992 74.90625 90.29296875 C73.72675781 90.28394531 72.54726562 90.27492188 71.33203125 90.265625 C69.97658203 90.24822266 69.97658203 90.24822266 68.59375 90.23046875 C68.60422363 90.78919678 68.61469727 91.3479248 68.62548828 91.92358398 C68.66758379 94.50499805 68.69324343 97.08633951 68.71875 99.66796875 C68.73550781 100.54646484 68.75226563 101.42496094 68.76953125 102.33007812 C68.81183078 108.06166423 68.63776591 113.80702284 66.59375 119.23046875 C65.7275 120.01421875 64.86125 120.79796875 63.96875 121.60546875 C60.65030586 125.27322279 61.15395747 128.1164376 61.3203125 132.90234375 C61.34498608 135.18830387 61.34498608 135.18830387 62.59375 136.23046875 C63.03956162 140.16847135 63.27782756 142.35768013 60.78125 145.54296875 C49.00174064 151.77917959 30.33495575 150.84954223 17.59375 148.04296875 C12.91410744 146.59370173 9.70988357 145.05886142 6.59375 141.23046875 C6.69178922 136.13242953 6.69178922 136.13242953 8.59375 134.23046875 C8.82738881 132.38154929 9.00678635 130.52558844 9.15625 128.66796875 C9.24003906 127.65605469 9.32382812 126.64414063 9.41015625 125.6015625 C9.47074219 124.81910156 9.53132813 124.03664063 9.59375 123.23046875 C8.10875 122.73546875 8.10875 122.73546875 6.59375 122.23046875 C2.1200073 115.47157691 2.09680805 109.67060229 2.34375 101.73046875 C2.36179687 100.621875 2.37984375 99.51328125 2.3984375 98.37109375 C2.4452385 95.65663579 2.51078625 92.94402159 2.59375 90.23046875 C1.90595459 90.23916992 1.21815918 90.24787109 0.50952148 90.25683594 C-0.84290649 90.2669873 -0.84290649 90.2669873 -2.22265625 90.27734375 C-3.11670166 90.28604492 -4.01074707 90.29474609 -4.93188477 90.30371094 C-8.82638358 90.18843224 -11.26777544 89.37959601 -14.01089478 86.61080933 C-15.89406824 83.39829818 -15.82643057 80.51402109 -15.79443359 76.89501953 C-15.79969055 76.16280182 -15.80494751 75.43058411 -15.81036377 74.67617798 C-15.82355129 72.25916108 -15.81482864 69.8428047 -15.8046875 67.42578125 C-15.80670904 65.7419319 -15.80962114 64.05808341 -15.81338501 62.37423706 C-15.81780703 58.84527246 -15.81138295 55.31653575 -15.79736328 51.78759766 C-15.78029764 47.27271879 -15.79009653 42.75837599 -15.80808067 38.24351692 C-15.81894432 34.76557409 -15.81545991 31.28775736 -15.8076973 27.80981064 C-15.80570105 26.14569917 -15.80813429 24.48157612 -15.81513596 22.81747818 C-15.82279017 20.4862482 -15.81109048 18.15587363 -15.79443359 15.82470703 C-15.80050629 15.14190674 -15.80657898 14.45910645 -15.81283569 13.75561523 C-15.75295452 9.21156091 -14.79360016 6.08978431 -12.40625 2.23046875 C-8.44768423 -0.19063386 -4.55596452 -0.0143287 0 0 Z M1.59375 19.23046875 C1.50021837 20.9184886 1.47630209 22.61042082 1.48022461 24.30102539 C1.48030014 25.38207047 1.48037567 26.46311554 1.48045349 27.57691956 C1.48561478 28.75294235 1.49077606 29.92896515 1.49609375 31.140625 C1.4975087 32.33779648 1.49892365 33.53496796 1.50038147 34.76841736 C1.50600021 38.60995941 1.51855589 42.45144418 1.53125 46.29296875 C1.53626259 48.88997312 1.54082591 51.4869784 1.54492188 54.08398438 C1.55597573 60.46616554 1.57273208 66.84831305 1.59375 73.23046875 C1.92375 73.23046875 2.25375 73.23046875 2.59375 73.23046875 C2.59375 68.61046875 2.59375 63.99046875 2.59375 59.23046875 C4.14835937 59.13958984 4.14835937 59.13958984 5.734375 59.046875 C7.10417873 58.96243504 8.47396975 58.87778878 9.84375 58.79296875 C10.52566406 58.75365234 11.20757812 58.71433594 11.91015625 58.67382812 C15.25640563 58.46265705 18.36179986 58.10708843 21.59375 57.23046875 C21.60833252 56.55991455 21.62291504 55.88936035 21.63793945 55.19848633 C21.712633 52.14608053 21.80922299 49.0947429 21.90625 46.04296875 C21.92880859 44.98787109 21.95136719 43.93277344 21.97460938 42.84570312 C22.01005859 41.82412109 22.04550781 40.80253906 22.08203125 39.75 C22.10821533 38.81260986 22.13439941 37.87521973 22.16137695 36.90942383 C22.79287395 32.99670979 24.32784628 30.18964426 27.49609375 27.7890625 C28.50349609 27.23412109 28.50349609 27.23412109 29.53125 26.66796875 C32.68012836 24.83547232 35.15139204 22.97812145 37.59375 20.23046875 C38.11324219 20.70097656 38.63273437 21.17148437 39.16796875 21.65625 C45.09100288 27.60849206 45.09100288 27.60849206 52.59375 30.23046875 C53.5759494 33.5067325 53.70955914 36.45834994 53.69140625 39.87109375 C53.68818359 40.94101562 53.68496094 42.0109375 53.68164062 43.11328125 C53.66907227 44.78003906 53.66907227 44.78003906 53.65625 46.48046875 C53.65173828 47.60710938 53.64722656 48.73375 53.64257812 49.89453125 C53.63080397 52.67323092 53.6143584 55.45182284 53.59375 58.23046875 C58.68516031 59.6751174 58.68516031 59.6751174 68.59375 59.23046875 C68.59375 67.15046875 68.59375 75.07046875 68.59375 83.23046875 C72.88375 83.23046875 77.17375 83.23046875 81.59375 83.23046875 C83.37656116 78.77344084 83.84065205 76.89449001 83.82080078 72.33862305 C83.82064972 71.17779709 83.82049866 70.01697113 83.82034302 68.82096863 C83.80485916 66.95665947 83.80485916 66.95665947 83.7890625 65.0546875 C83.78481766 63.1342437 83.78481766 63.1342437 83.78048706 61.17500305 C83.7728778 57.783438 83.75325293 54.39204625 83.7310791 51.00054932 C83.71056206 47.53489526 83.70147286 44.069213 83.69140625 40.60351562 C83.66936492 33.81242509 83.63590129 27.02146263 83.59375 20.23046875 C80.73816086 18.80267418 78.22748574 19.00966639 75.03515625 18.9140625 C74.35491394 18.89319077 73.67467163 18.87231903 72.97381592 18.85081482 C70.70141902 18.78382882 68.42891198 18.72521791 66.15625 18.66796875 C64.98864639 18.63669891 64.98864639 18.63669891 63.79745483 18.60479736 C49.83470694 18.23720271 35.87343641 18.1232303 21.90625 18.10546875 C20.46537521 18.10158646 20.46537521 18.10158646 18.99539185 18.09762573 C16.27423286 18.09182058 13.55319085 18.09332054 10.83203125 18.09765625 C9.60018097 18.09468788 9.60018097 18.09468788 8.34344482 18.09165955 C4.66763913 17.75702387 4.66763913 17.75702387 1.59375 19.23046875 Z M6.59375 63.23046875 C6.49193492 69.91978892 6.42211085 76.60890762 6.37402344 83.29882812 C6.35396683 85.57234159 6.32671462 87.84580385 6.29199219 90.11914062 C6.24321288 93.39596224 6.22072103 96.672099 6.203125 99.94921875 C6.18247986 100.95786987 6.16183472 101.966521 6.14056396 103.0057373 C6.1385109 109.5320138 7.22869714 113.61816606 10.59375 119.23046875 C11.22216797 119.15344727 11.85058594 119.07642578 12.49804688 118.99707031 C26.94921498 117.30965847 41.33356758 117.29593215 55.44140625 120.96484375 C58.6676202 121.59055411 58.6676202 121.59055411 60.96484375 119.43359375 C63.40129218 116.13825343 63.71955836 114.3879053 63.72314453 110.33764648 C63.72787277 108.81112709 63.72787277 108.81112709 63.73269653 107.25376892 C63.7306723 106.1516658 63.72864807 105.04956268 63.7265625 103.9140625 C63.72751923 102.78726578 63.72847595 101.66046906 63.72946167 100.49952698 C63.73014303 98.11467432 63.72829181 95.72981981 63.72412109 93.3449707 C63.71876729 89.67980823 63.72407017 86.01476804 63.73046875 82.34960938 C63.72980806 80.03776014 63.72852708 77.72591099 63.7265625 75.4140625 C63.72858673 74.30993515 63.73061096 73.2058078 63.73269653 72.06822205 C63.72954437 71.05369461 63.72639221 70.03916718 63.72314453 68.99389648 C63.72234894 68.09613998 63.72155334 67.19838348 63.72073364 66.27342224 C63.82035672 64.23644951 63.82035672 64.23644951 62.59375 63.23046875 C52.55055956 61.82909334 42.28620807 62.07552351 32.17016602 62.10009766 C29.5046639 62.10552286 26.83932557 62.10008656 24.17382812 62.09375 C22.46874963 62.09440977 20.76367124 62.09568883 19.05859375 62.09765625 C18.26694321 62.09563202 17.47529266 62.09360779 16.65965271 62.09152222 C13.13342847 62.10657234 9.98626834 62.28268157 6.59375 63.23046875 Z M13.59375 124.23046875 C13.52226801 125.58290792 13.50975546 126.93881242 13.53125 128.29296875 C13.551875 129.59234375 13.5725 130.89171875 13.59375 132.23046875 C15.20830078 132.01390625 15.20830078 132.01390625 16.85546875 131.79296875 C30.12404228 130.07734967 42.37711119 129.56332722 55.59375 132.23046875 C55.92375 129.59046875 56.25375 126.95046875 56.59375 124.23046875 C48.76987425 121.8319083 41.48944178 120.93010386 33.34375 120.91796875 C32.51713867 120.9128125 31.69052734 120.90765625 30.83886719 120.90234375 C21.61542979 120.75325645 21.61542979 120.75325645 13.59375 124.23046875 Z M26.59375 133.23046875 C27.91375 133.56046875 29.23375 133.89046875 30.59375 134.23046875 C30.59375 134.89046875 30.59375 135.55046875 30.59375 136.23046875 C28.11875 135.73546875 28.11875 135.73546875 25.59375 135.23046875 C25.59375 134.90046875 25.59375 134.57046875 25.59375 134.23046875 C23.94375 134.23046875 22.29375 134.23046875 20.59375 134.23046875 C21.58375 134.56046875 22.57375 134.89046875 23.59375 135.23046875 C23.59375 135.89046875 23.59375 136.55046875 23.59375 137.23046875 C21.94375 137.23046875 20.29375 137.23046875 18.59375 137.23046875 C18.59375 136.57046875 18.59375 135.91046875 18.59375 135.23046875 C16.61375 136.22046875 16.61375 136.22046875 14.59375 137.23046875 C15.25375 137.89046875 15.91375 138.55046875 16.59375 139.23046875 C14.94375 139.23046875 13.29375 139.23046875 11.59375 139.23046875 C14.91932156 143.3874332 18.50664949 144.44182607 23.59375 145.23046875 C27.59875794 145.45413047 31.58418583 145.42070571 35.59375 145.35546875 C37.18509766 145.34193359 37.18509766 145.34193359 38.80859375 145.328125 C41.40388638 145.30474399 43.99869465 145.27197431 46.59375 145.23046875 C46.09875 143.25046875 46.09875 143.25046875 45.59375 141.23046875 C47.24375 141.23046875 48.89375 141.23046875 50.59375 141.23046875 C50.59375 141.89046875 50.59375 142.55046875 50.59375 143.23046875 C52.24375 142.90046875 53.89375 142.57046875 55.59375 142.23046875 C54.60375 140.91046875 53.61375 139.59046875 52.59375 138.23046875 C53.91375 137.90046875 55.23375 137.57046875 56.59375 137.23046875 C54.61375 136.57046875 52.63375 135.91046875 50.59375 135.23046875 C50.59375 135.89046875 50.59375 136.55046875 50.59375 137.23046875 C48.94375 137.23046875 47.29375 137.23046875 45.59375 137.23046875 C45.59375 136.57046875 45.59375 135.91046875 45.59375 135.23046875 C46.91375 134.90046875 48.23375 134.57046875 49.59375 134.23046875 C47.61375 134.23046875 45.63375 134.23046875 43.59375 134.23046875 C43.59375 134.56046875 43.59375 134.89046875 43.59375 135.23046875 C41.94375 135.56046875 40.29375 135.89046875 38.59375 136.23046875 C38.59375 135.57046875 38.59375 134.91046875 38.59375 134.23046875 C39.91375 133.90046875 41.23375 133.57046875 42.59375 133.23046875 C37.31375 133.23046875 32.03375 133.23046875 26.59375 133.23046875 Z " fill="#2F3290" transform="translate(15.40625,5.76953125)"/>
                    <path d="M0 0 C2.47738851 2.07780971 3.86626026 3.66171713 5.0625 6.6875 C4.99407339 10.31411013 4.34353367 11.41800752 2.5 14.4375 C0.43394735 17.82559742 -0.00330985 18.79147949 0.0625 22.9375 C0.76053535 26.0733055 0.76053535 26.0733055 3 28 C6.59679066 27.67673447 6.59679066 27.67673447 10 27 C12.01512227 22.78134972 12.41354068 18.79114568 12.625 14.1875 C12.66367187 13.49462891 12.70234375 12.80175781 12.7421875 12.08789062 C12.83573568 10.39232985 12.91892364 8.69620288 13 7 C14.9375 7.375 14.9375 7.375 17 8 C17.33 8.66 17.66 9.32 18 10 C18.66 9.01 19.32 8.02 20 7 C21.32 7.66 22.64 8.32 24 9 C24.33 8.34 24.66 7.68 25 7 C26.8125 7.1875 26.8125 7.1875 29 8 C30.8125 10.25 30.8125 10.25 32 13 C31.6875 15.8125 31.6875 15.8125 31 18 C31.99 18 32.98 18 34 18 C34.0825 17.0925 34.165 16.185 34.25 15.25 C35.13067304 11.43375015 35.79164097 10.22117164 39 8 C41.70311384 7.38495115 44.21627958 7.18558136 47 7 C47 10.63 47 14.26 47 18 C50.3 18 53.6 18 57 18 C57 14.7 57 11.4 57 8 C61 10 61 10 63 13 C63.25760279 15.69452521 63.08900053 18.28548375 63 21 C65.91652174 21.16681109 65.91652174 21.16681109 69 21 C71.68092691 18.31907309 71.38670257 16.60832637 71.625 12.875 C71.69976562 11.77929688 71.77453125 10.68359375 71.8515625 9.5546875 C71.92503906 8.29011719 71.92503906 8.29011719 72 7 C74 7 74 7 76.1875 8.875 C78.47476364 12.81855799 78.34303655 15.19269722 77.65625 19.6171875 C76.60568499 23.43173902 75.37479472 24.93379915 72 27 C66.97428927 27.89462913 63.04377464 27.41993468 58.30078125 25.51171875 C50.83889075 22.91580633 42.74647303 23.42155729 34.9375 23.3125 C33.29229136 23.27927492 31.64710783 23.24478059 30.00195312 23.20898438 C26.00144183 23.12467507 22.00098151 23.05758868 18 23 C17.88398438 24.10601562 17.76796875 25.21203125 17.6484375 26.3515625 C17 30 17 30 14.625 32.375 C10.31909061 35.04056296 7.00883698 35.34543703 2 35 C-0.78901573 33.76043745 -2.44350587 32.71549246 -4.3125 30.3125 C-5.53698064 26.19379239 -6.00364933 22.06839037 -4.1015625 18.1484375 C-3 16.5 -3 16.5 -1 14 C-1.66 13.67 -2.32 13.34 -3 13 C-2.88557539 11.39504433 -2.75805306 9.79101881 -2.625 8.1875 C-2.52058594 6.84751953 -2.52058594 6.84751953 -2.4140625 5.48046875 C-2 3 -2 3 0 0 Z M18 13 C18 14.65 18 16.3 18 18 C18.33 18 18.66 18 19 18 C19 16.35 19 14.7 19 13 C18.67 13 18.34 13 18 13 Z M25 13 C24.67 13.99 24.34 14.98 24 16 C24.66 16.66 25.32 17.32 26 18 C26 16.35 26 14.7 26 13 C25.67 13 25.34 13 25 13 Z M41 15 C40.01 16.485 40.01 16.485 39 18 C39.99 18 40.98 18 42 18 C41.67 17.01 41.34 16.02 41 15 Z " fill="#2F3290" transform="translate(8,156)"/>
                    <path d="M0 0 C3.52787301 1.95657197 5.70285021 4.10855063 7 8 C7.38651765 12.09708709 7.20803626 14.54058659 5.5 18.3125 C2.71658875 21.3046671 1.03760633 22.22423429 -2.90625 22.9453125 C-6.55905209 23.04072151 -8.92739642 21.867661 -12 20 C-14.96015387 16.65789079 -15.58185442 13.46356309 -15.4296875 9 C-14.65395507 5.38931815 -12.60947818 3.54734775 -10 1 C-6.76918255 -0.61540873 -3.49240902 -0.5896275 0 0 Z " fill="#2F3290" transform="translate(39,71)"/>
                    <path d="M0 0 C3.86728738 1.6814293 5.41933877 3.15233779 7 7 C7.7099797 11.61486808 7.62455021 15.00071966 5.125 19 C1.43251691 22.47527821 -1.59613475 22.41023124 -6.515625 22.33203125 C-9 22 -9 22 -12.0625 20.0625 C-14.59402156 16.06106269 -15.30000092 12.71430022 -15 8 C-12.09754529 0.97300439 -7.40500148 -1.0894038 0 0 Z " fill="#2F3290" transform="translate(70,71)"/>
                    <path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C3 3.31 3 5.62 3 8 C2.48695312 7.80792969 1.97390625 7.61585937 1.4453125 7.41796875 C-1.98346067 6.83190049 -4.73974119 7.56689498 -8.125 8.3125 C-9.36507812 8.57675781 -10.60515625 8.84101563 -11.8828125 9.11328125 C-15.07147833 9.7470412 -15.07147833 9.7470412 -17 12 C-20.01826653 12.27240673 -22.96370622 12.08675125 -26 12 C-26 8.37 -26 4.74 -26 1 C-18.25 0.875 -18.25 0.875 -16 2 C-13.66416964 1.93702418 -11.32999162 1.8016592 -9 1.625 C-7.741875 1.53476562 -6.48375 1.44453125 -5.1875 1.3515625 C-2.10761415 1.19816649 -2.10761415 1.19816649 0 0 Z " fill="#2F3290" transform="translate(93,2)"/>
                    <path d="M0 0 C1.890625 0.21484375 1.890625 0.21484375 4 1 C5.46742502 3.89652178 6.11450315 6.85648617 7 10 C7.33 6.7 7.66 3.4 8 0 C10.64 0 13.28 0 16 0 C16 1.32 16 2.64 16 4 C14.35 4 12.7 4 11 4 C11 4.66 11 5.32 11 6 C12.65 6 14.3 6 16 6 C16 6.99 16 7.98 16 9 C14.35 9 12.7 9 11 9 C11 9.66 11 10.32 11 11 C12.65 11 14.3 11 16 11 C16 12.32 16 13.64 16 15 C12.04 15 8.08 15 4 15 C4 14.01 4 13.02 4 12 C2.68 12 1.36 12 0 12 C0 12.99 0 13.98 0 15 C-1.32 15 -2.64 15 -4 15 C-3.52229477 13.06213915 -3.04278429 11.12472326 -2.5625 9.1875 C-2.29566406 8.10855469 -2.02882813 7.02960938 -1.75390625 5.91796875 C-1.23922588 3.9259157 -0.65062825 1.95188476 0 0 Z " fill="#2F3290" transform="translate(30,99)"/>
                    <path d="M0 0 C0.66 0 1.32 0 2 0 C3.32 2.31 4.64 4.62 6 7 C5.67 7.33 5.34 7.66 5 8 C4.84235595 9.77869726 4.74899323 11.56318476 4.68359375 13.34765625 C4.64169922 14.42724609 4.59980469 15.50683594 4.55664062 16.61914062 C4.51732422 17.75544922 4.47800781 18.89175781 4.4375 20.0625 C4.37272461 21.77276367 4.37272461 21.77276367 4.30664062 23.51757812 C4.20017161 26.34492195 4.09815793 29.17235738 4 32 C2.35 32 0.7 32 -1 32 C-1.02465504 27.60343827 -1.04283842 23.2069128 -1.05493164 18.81030273 C-1.05997121 17.31355082 -1.06680287 15.81680384 -1.07543945 14.32006836 C-1.08752159 12.17300193 -1.09323191 10.02600038 -1.09765625 7.87890625 C-1.10289307 6.5854126 -1.10812988 5.29191895 -1.11352539 3.95922852 C-1 1 -1 1 0 0 Z " fill="#2F3290" transform="translate(89,148)"/>
                    <path d="M0 0 C1.32 0 2.64 0 4 0 C4.33 1.32 4.66 2.64 5 4 C5.33 2.68 5.66 1.36 6 0 C7.32 0 8.64 0 10 0 C10 4.95 10 9.9 10 15 C6.7 15 3.4 15 0 15 C0 10.05 0 5.1 0 0 Z " fill="#2F3290" transform="translate(57,99)"/>
                    <path d="M0 0 C2.97 0 5.94 0 9 0 C9 1.32 9 2.64 9 4 C7.02 4 5.04 4 3 4 C3 4.66 3 5.32 3 6 C4.65 6 6.3 6 8 6 C8 6.99 8 7.98 8 9 C6.35 9 4.7 9 3 9 C3 9.66 3 10.32 3 11 C4.98 11 6.96 11 9 11 C9 12.32 9 13.64 9 15 C6.03 15 3.06 15 0 15 C0 10.05 0 5.1 0 0 Z " fill="#2F3290" transform="translate(47,99)"/>
                    <path d="M0 0 C2.5 0.25 2.5 0.25 4.5 2.25 C4.0625 4.3125 4.0625 4.3125 3.5 6.25 C3.83 6.58 4.16 6.91 4.5 7.25 C4.6875 10.1875 4.6875 10.1875 4.5 13.25 C2.5 15.25 2.5 15.25 0 15.5 C-2.5 15.25 -2.5 15.25 -4.5 13.25 C-4.17558396 11.58157466 -3.84060811 9.91519519 -3.5 8.25 C-3.685625 7.198125 -3.87125 6.14625 -4.0625 5.0625 C-4.206875 4.134375 -4.35125 3.20625 -4.5 2.25 C-2.5 0.25 -2.5 0.25 0 0 Z M-0.5 3.25 C-0.83 3.91 -1.16 4.57 -1.5 5.25 C-0.51 4.92 0.48 4.59 1.5 4.25 C0.84 3.92 0.18 3.59 -0.5 3.25 Z M-1.5 9.25 C-1.17 10.24 -0.84 11.23 -0.5 12.25 C0.16 11.59 0.82 10.93 1.5 10.25 C0.51 9.92 -0.48 9.59 -1.5 9.25 Z " fill="#2F3290" transform="translate(72.5,98.75)"/>
                    <path d="M0 0 C0.8146875 0.00257813 1.629375 0.00515625 2.46875 0.0078125 C3.2834375 0.00523437 4.098125 0.00265625 4.9375 0 C6.96875 0.1328125 6.96875 0.1328125 7.96875 1.1328125 C8.00938832 2.79898365 8.011471 4.46669345 7.96875 6.1328125 C4.21875 7.2578125 4.21875 7.2578125 1.96875 6.1328125 C0.30255554 6.0931412 -1.36516013 6.08896803 -3.03125 6.1328125 C-3.073971 4.46669345 -3.07188832 2.79898365 -3.03125 1.1328125 C-2.03125 0.1328125 -2.03125 0.1328125 0 0 Z " fill="#2F3290" transform="translate(73.03125,183.8671875)"/>
                    <path d="M0 0 C1.37478516 0.01740234 1.37478516 0.01740234 2.77734375 0.03515625 C3.69644531 0.04417969 4.61554687 0.05320313 5.5625 0.0625 C6.27277344 0.07410156 6.98304687 0.08570313 7.71484375 0.09765625 C7.71484375 1.74765625 7.71484375 3.39765625 7.71484375 5.09765625 C4.30921523 5.87608563 1.20718619 6.19743746 -2.28515625 6.09765625 C-2.66734392 4.44150968 -2.99910727 2.77308601 -3.28515625 1.09765625 C-2.28515625 0.09765625 -2.28515625 0.09765625 0 0 Z " fill="#2F3290" transform="translate(58.28515625,183.90234375)"/>
                    <path d="M0 0 C1.98 0 3.96 0 6 0 C6 0.66 6 1.32 6 2 C4.02 2 2.04 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(47,148)"/>
                    <path d="M0 0 C1.98 0 3.96 0 6 0 C6 0.66 6 1.32 6 2 C4.02 2 2.04 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(47,144)"/>
                    <path d="M0 0 C1.98 0 3.96 0 6 0 C6 0.66 6 1.32 6 2 C4.02 2 2.04 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(47,140)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(54,148)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(41,148)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(34,147)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(61,144)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(54,144)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(41,144)"/>
                    <path d="M0 0 C1.65 0 3.3 0 5 0 C5 0.66 5 1.32 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#2F3290" transform="translate(34,144)"/>
                </svg>
                
                <div class="company-info">
                    <div class="company-name">Arab Emergency Company Ltd.</div>
                    <div class="company-subtitle">Fire Fighting and Fire Alarm Installation and Maintainence</div>
                </div>
            </div>
            
            <div class="report-title-container">
                <div class="report-title">Engineering Report</div>
                <div class="report-subtitle">Technical Assessment & Analysis</div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="content">
            <div class="form-section">
                <h3>Report Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Report Number:</label>
                        <div class="form-control">AEC-ENG-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}</div>
                    </div>
                    <div class="form-group">
                        <label>Report Date:</label>
                        <div class="form-control">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Engineer Name:</label>
                        <div class="form-control">${engineer.displayName}</div>
                    </div>
                    <div class="form-group">
                        <label>Engineer Email:</label>
                        <div class="form-control">${engineer.email}</div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Assigned Projects Summary</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Assigned Projects:</label>
                        <div class="form-control">${projectsWithTickets.length}</div>
                    </div>
                    <div class="form-group">
                        <label>Total Open Tickets:</label>
                        <div class="form-control">${totalOpenTickets}</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Resolved Tickets:</label>
                        <div class="form-control">${totalResolvedTickets}</div>
                    </div>
                    <div class="form-group">
                        <label>Total Tickets:</label>
                        <div class="form-control">${totalOpenTickets + totalResolvedTickets}</div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Project Details</h3>
                ${projectsWithTickets.length > 0 ? projectsWithTickets.map((project: any, index: number) => `
                <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project ${index + 1}:</label>
                            <div class="form-control">${project.companyName || 'N/A'}</div>
                        </div>
                        <div class="form-group">
                            <label>Open / Resolved Tickets:</label>
                            <div class="form-control">${project.tickets.open.length} / ${project.tickets.resolved.length}</div>
                        </div>
                    </div>
                    ${[...project.tickets.open, ...project.tickets.resolved].length > 0 ? `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #e0e0e0; padding: 8px; text-align: left;">Ticket ID</th>
                                <th style="border: 1px solid #e0e0e0; padding: 8px; text-align: left;">Ticket Name</th>
                                <th style="border: 1px solid #e0e0e0; padding: 8px; text-align: center;">Created At</th>
                                <th style="border: 1px solid #e0e0e0; padding: 8px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...project.tickets.open, ...project.tickets.resolved].map((ticket: any) => `
                            <tr>
                                <td style="border: 1px solid #e0e0e0; padding: 8px;">${ticket.readable_id || ticket.id || 'N/A'}</td>
                                <td style="border: 1px solid #e0e0e0; padding: 8px;">${ticket.title || 'N/A'}</td>
                                <td style="border: 1px solid #e0e0e0; padding: 8px; text-align: center;">${ticket.createdAt ? new Date(ticket.createdAt.toDate ? ticket.createdAt.toDate() : ticket.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}</td>
                                <td style="border: 1px solid #e0e0e0; padding: 8px; text-align: center;">
                                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; background-color: ${ticket.status?.toLowerCase() === 'resolved' ? '#d4edda' : '#fff3cd'}; color: ${ticket.status?.toLowerCase() === 'resolved' ? '#155724' : '#856404'};">
                                        ${ticket.status || 'N/A'}
                                    </span>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : '<div style="margin-top: 10px; color: #777; font-size: 12px;">No tickets for this project</div>'}
                </div>
                `).join('') : '<div class="form-control">No projects assigned</div>'}
            </div>
            
            <div class="signature-area">
                <h3>Approval</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prepared By:</label>
                        <div class="form-control">${engineer.displayName}</div>
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <div class="form-control">${engineer.role}</div>
                    </div>
                </div>
                <div class="signature-line">
                    <div class="signature-label">Authorized Signature</div>
                </div>
            </div>
        </div>
        
        <!-- Footer Section -->
        <div class="footer">
            <div class="engineer-name">${engineer.displayName.toUpperCase()}</div>
            <div class="footer-note">Arab Emergency Company Maintainence Department | This report is confidential and intended for authorized use only</div>
        </div>
    </div>
</body>
</html>
      `;

      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.print();
      }
    } catch (error) {
      console.error('Error generating print report:', error);
    } finally {
      setPrinting(null);
    }
  };

  const getTranslatedName = (displayName: string) => {
    const translationKey = `engineers.engineerNames.${displayName}`;
    const translated = tEn(translationKey);
    return translated === translationKey ? displayName : translated;
  };

  const getTranslatedRole = (role: string) => {
    const translationKey = `engineers.role.${role.toLowerCase()}`;
    return t(translationKey) || role;
  };

  useEffect(() => {
    const fetchEngineersAndProjects = async () => {
      const engineersRef = collection(db, 'engineers');
      const usersRef = collection(db, 'users');

      const unsubscribeEngineers = onSnapshot(query(engineersRef), async (snapshot) => {
        const engineersData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })) as Engineer[];

        // Filter out admins and only keep engineers
        const engineersOnly = engineersData.filter(engineer => engineer.role.toLowerCase() === 'engineer');

        const engineersWithProjects = await Promise.all(
          engineersOnly.map(async (engineer) => {
            const projectsQuery = query(usersRef, where('responsible_engineer', '==', engineer.email));
            const projectsSnapshot = await getDocs(projectsQuery);

            return {
              ...engineer,
              assignedProjects: projectsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }))
            };
          })
        );

        setEngineers(engineersWithProjects);
        setLoading(false);
      });

      return () => {
        unsubscribeEngineers();
      };
    };

    fetchEngineersAndProjects();
  }, []);

  const getAvailabilityColor = (availability?: string) => {
    switch (availability) {
      case 'available':
        return 'bg-meta-3/10 text-meta-3';
      case 'busy':
        return 'bg-meta-1/10 text-meta-1';
      case 'away':
        return 'bg-meta-6/10 text-meta-6';
      default:
        return 'bg-gray-100 text-gray-600';
    }
  };

  const EngineerCard = ({ engineer }: { engineer: Engineer }) => {
    const isExpanded = expandedEngineerId === engineer.id;

    return (
      <motion.div
        layout
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: 20 }}
        className={`bg-white dark:bg-boxdark border border-stroke dark:border-strokedark rounded-sm shadow-default hover:shadow-md transition-shadow duration-300 overflow-hidden cursor-pointer`}
        onClick={() => setExpandedEngineerId(isExpanded ? null : engineer.id)}
      >
        <motion.div layout className="p-6">
          <motion.div layout className="flex items-center space-x-4">
            <motion.div
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="w-16 h-16 rounded-sm bg-gray-100 dark:bg-meta-4 flex items-center justify-center transform transition-transform duration-300"
            >
              <span className="text-2xl font-bold text-gray-700 dark:text-white">
                {getTranslatedName(engineer.displayName).charAt(0).toUpperCase()}
              </span>
            </motion.div>
            <div className="flex-1 min-w-0">
              <motion.h3 layout className="text-xl font-semibold text-black dark:text-white truncate">
                {getTranslatedName(engineer.displayName)}
              </motion.h3>
              <motion.div layout className="flex items-center space-x-2 mt-1">
                <span className="inline-flex rounded-sm px-2.5 py-1 text-xs font-medium bg-gray-100 dark:bg-meta-4 text-gray-700 dark:text-white">
                  {getTranslatedRole(engineer.role)}
                </span>
                {engineer.availability && (
                  <span className={`inline-flex rounded-sm px-2.5 py-1 text-xs font-medium ${getAvailabilityColor(engineer.availability)}`}>
                    {t(`engineers.availability.${engineer.availability}`)}
                  </span>
                )}
              </motion.div>
            </div>
          </motion.div>

          <AnimatePresence>
            {isExpanded && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="mt-6 space-y-4 text-sm border-t border-stroke dark:border-strokedark pt-4"
              >
                <motion.div
                  initial={{ y: -10, opacity: 0 }}
                  animate={{ y: 0, opacity: 1 }}
                  transition={{ delay: 0.1 }}
                  className="flex items-center text-gray-600 dark:text-gray-300"
                >
                  <svg className="w-4 h-4 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2" />
                  </svg>
                  <span className="truncate">{engineer.email}</span>
                </motion.div>

                {engineer.assignedProjects && engineer.assignedProjects.length > 0 && (
                  <motion.div
                    initial={{ y: -10, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    transition={{ delay: 0.2 }}
                    className="space-y-2"
                  >
                    <div className="flex items-center text-gray-600 dark:text-gray-300">
                      <svg className="w-4 h-4 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                      </svg>
                      <span className="font-medium">{t('engineers.assignedProjects')}</span>
                    </div>
                    <div className="ml-7">
                      <div className="flex flex-wrap gap-2">
                        {engineer.assignedProjects.map((project) => (
                          <span
                            key={project.id}
                            className="inline-flex rounded-sm px-2.5 py-1 text-xs font-medium bg-gray-100 dark:bg-meta-4 text-gray-700 dark:text-white"
                          >
                            {project.companyName || t('engineers.unnamedCompany')}
                          </span>
                        ))}
                      </div>
                    </div>
                  </motion.div>
                )}

                {engineer.specialties && engineer.specialties.length > 0 && (
                  <motion.div
                    initial={{ y: -10, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    transition={{ delay: 0.25 }}
                    className="space-y-2"
                  >
                    <div className="flex items-center text-gray-600 dark:text-gray-300">
                      <svg className="w-4 h-4 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                      </svg>
                      <span className="font-medium">{t('engineers.specialties')}</span>
                    </div>
                    <div className="ml-7">
                      <div className="flex flex-wrap gap-2">
                        {engineer.specialties.map((specialty, index) => (
                          <span
                            key={index}
                            className="inline-flex rounded-sm px-2.5 py-1 text-xs font-medium bg-gray-100 dark:bg-meta-4 text-gray-700 dark:text-white"
                          >
                            {specialty}
                          </span>
                        ))}
                      </div>
                    </div>
                  </motion.div>
                )}
                <button
                  className="bg-primary text-white rounded-sm py-2.5 px-4 mt-4"
                  onClick={(e) => handlePrintEngineerDetails(engineer, e)}
                >
                  {t('engineers.printReport')}
                </button>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      </motion.div>
    );
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-80">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        <span className="ml-3">{t('engineers.loading')}</span>
      </div>
    );
  }

  return (
    <div className="rounded-sm border border-stroke dark:border-strokedark bg-white dark:bg-boxdark px-5 pt-6 pb-2.5 shadow-default dark:shadow-default dark:text-white">

      <div className="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6 xl:grid-cols-3 2xl:gap-7.5">
        {engineers.length === 0 ? (
          <div className="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
            {t('engineers.noEngineers')}
          </div>
        ) : (
          engineers.map((engineer) => (
            <EngineerCard key={engineer.id} engineer={engineer} />
          ))
        )}
      </div>
    </div>
  );
};

export default EngineersList;